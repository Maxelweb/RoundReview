{% extends 'project/base.html' %}

{% block inner_content %}
    <h3><i class="fas fa-file primary my-1"></i> Project Resources</h3>
    <p>Click on a resource to explore more.</p>

    <div class="my-2">
        <a href="{{ url_for('project.create_object', project_id=project.id) }}"><button><i class="fas fa-plus-circle"></i> New Document</button></a>
    </div>

    <table id="resource-table" class="resource-table">
        <tr>
            <th colspan="4">Resources</th>
        </tr>
        {% macro render_tree(tree, parent_path='') %}
            
        
            {% for key, value in tree.items() %}
            {% if key != '_objects' %}
                {% set current_path = parent_path + '/' + key %}
                <tr class="folder-row" data-folder-path="{{ current_path }}" {% if path and (path == current_path or path.startswith(current_path + '/')) %}data-open="true"{% endif %}>
                <td colspan="3" class="folder-link">
                    <i class="fas fa-folder"></i>
                    <a href="#" class="folder-link-key">{{ key }}</a> 
                </td>
                <td class="folder-actions">
                    <span class="action-item">
                        {{ (value|length - (1 if '_objects' in value else 0)) + (value['_objects']|length if '_objects' in value else 0) }} items
                    </span>
                    <span class="action-item">
                        <a href="{{ url_for('project.create_object', project_id=project.id, folder_path=current_path) }}" title="Add new document here">
                            <i class="fas fa-plus-circle"></i>
                        </a>
                    </span>
                    <span class="action-item">
                        <a href="{{ url_for('project.view_objects', project_id=project.id, path=current_path) }}" title="Copy link to this folder">
                            <i class="fas fa-link"></i>
                        </a>
                    </span>
                </td>
                </tr>
                {% if value %}
                <tr class="folder-file" data-folder-path="{{ current_path }}" style="display: {% if path and (path == current_path or path.startswith(current_path + '/')) %}table-row{% else %}none{% endif %};">
                    <td colspan="4" class="nested-table-cell">
                    <table class="nested-table">
                        {{ render_tree(value, current_path) }}
                    </table>
                    </td>
                </tr>
                {% endif %}
            {% endif %}
            {% endfor %}


            {% for obj in tree['_objects'] %}
            <tr>
                <td>
                    <i class="fas fa-file-alt"></i>
                    <a href="{{ url_for('object.view_object', project_id=project.id, object_id=obj.id) }}" class="resource-link">
                    {{ obj.name }}
                    </a>
                </td>
                <td class="small text-center">{{ obj.version }}</td>
                <td class="small">
                <span class="status-label" style="background-color: 
                {% if obj.status.value == 'No Review' %}gray
                {% elif obj.status.value == 'Pending Review' %}orange
                {% elif obj.status.value == 'Under Review' %}blue
                {% elif obj.status.value == 'Require Changes' %}red
                {% elif obj.status.value == 'Approved' %}green
                {% else %}black
                {% endif %};">
                {{ obj.status.value }}</span>
                </td>
                <td width="200px" class="small text-muted">{{ obj.description }}</td>
            </tr>
            {% endfor %}
        {% endmacro %}
        {{ render_tree(tree['root']) }}
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const folderLinks = document.querySelectorAll('.folder-link');
            folderLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    const folderPath = this.closest('.folder-row').dataset.folderPath;
                    const folderContent = document.querySelector(`.folder-file[data-folder-path="${folderPath}"]`);
                    if (folderContent) {
                        const isOpen = folderContent.style.display !== 'none';
                        folderContent.style.display = isOpen ? 'none' : '';
                        this.closest('.folder-row').dataset.open = !isOpen;
                    }
                });
            });
        });
    </script>


{% endblock %}