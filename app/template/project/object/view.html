{% extends 'project/base_wide.html' %}

{% block inner_content %}
    <div class="container">
        <a href="{{ url_for('project.view_objects', project_id=project.id) }}">&larr; Back to project</a>
        <h3><i class="fas fa-file primary my-1"></i> {{ object.name }}</h3>
        <p class="muted">
            Project: {{ project.title }} - v{{ object.version }} - {{ object.description if object.description else "No description" }}
        </p>
    </div>

    <div class="object-details">
        {% if object.status == 'Approved' %}
        <div class="form-group text-center">
            <a href="{{ url_for('object.download_signed', object_id=object.id) }}" class="btn btn-success">
                Download Digitally Signed Version
            </a>
        </div>
        {% endif %}
    </div>
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

    <div class="pdf-container">
        <div class="pdf-navbar container" id="controls">
            <div class="pdf-control">
                <button id="prev-page"><i class="fas fa-arrow-left"></i></button>
                <button id="next-page"><i class="fas fa-arrow-right"></i></button>
                Page: <span class="bold" id="page-num">1</span> / 
                <span id="total-pages-num"></span>
            </div>
                <div class="pdf-control pdf-status"><span class="status-label" style="background-color: 
                    {% if object.status.value == 'No Review' %}gray
                    {% elif object.status.value == 'Pending Review' %}orange
                    {% elif object.status.value == 'Under Review' %}blue
                    {% elif object.status.value == 'Require Changes' %}red
                    {% elif object.status.value == 'Approved' %}green
                    {% else %}black
                    {% endif %};">
                        {{ object.status.value }}
                    </span>
                </div>
            <div class="pdf-control">
                <button id="reset-scale" style="display: none;"><i class="fas fa-undo"></i> Reset</button>
                <button id="page-zoom-in"><i class="fas fa-search-plus"></i></button>
                <button id="page-zoom-out"><i class="fas fa-search-minus"></i></button>
                Scale: <span class="bold" id="page-scale"></span>
            </div>
        </div>
        <div class="pdf-viewer" id="pdf-container">
            <canvas id="pdf-canvas"></canvas>
            <div id="markers"></div>
            <textarea id="comment-input" class="comment-textarea" placeholder="Write the comment here (press ESC to quit)"></textarea>
        </div>

        <div class="pdf-sidebar" id="sidebar">
            <h3><span class="badge-total" id="total-page-comments">0</span> Comments on this page</h3>
            <div id="comments-list"></div>
        </div>

        <script>
            const url = "{{ url_for('object.get_file', project_id=project.id, object_id=object.id) }}";
            let pdfscale = 1.35; // Scala per posizionare i marker correttamente
            const pdfscaleDefault = 1.35;
            let pdfInstance = null;
            let currentPage = 1;
            let lastClick = { x: 0, y: 0 };
            const canvas = document.getElementById("pdf-canvas");
            const context = canvas.getContext("2d");
            const input = document.getElementById("comment-input");
            const markers = document.getElementById("markers");
            const commentsList = document.getElementById("comments-list");
            const pageNumDisplay = document.getElementById("page-num");
            const totalPageNumDisplay = document.getElementById("total-pages-num");
            const pageScaleDisplay = document.getElementById("page-scale");
            const totalPageComments = document.getElementById("total-page-comments");

            pdfjsLib.getDocument(url).promise.then(pdf => {
                pdfInstance = pdf;
                totalPageNumDisplay.textContent = pdf.numPages;
                pageScaleDisplay.textContent = (pdfscale * 100).toFixed(0) + "%";
                renderPage(currentPage);
            });

            function renderPage(pageNumber, scale = pdfscale) {
                pdfInstance.getPage(pageNumber).then(page => {
                    // const scale = 1.60; // window.innerHeight / page.getViewport({ scale: 1 }).height; // Previous: 1.75
                    const viewport = page.getViewport({ scale });
                    canvas.width =  viewport.width;
                    canvas.height = viewport.height;
                    const renderContext = { canvasContext: context, viewport };
                    return page.render(renderContext).promise;
                }).then(() => {
                    pageNumDisplay.textContent = pageNumber;
                    loadAnnotations();
                });
            }

            document.getElementById("next-page").addEventListener("click", () => {
                if (currentPage < pdfInstance.numPages) {
                    currentPage++;
                    renderPage(currentPage);
                }
            });

            document.getElementById("prev-page").addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage(currentPage);
                }
            });
            
            // Event listeners for zooming in and out
            document.getElementById("page-zoom-in").addEventListener("click", () => {
                pdfscale = Math.min(pdfscale + 0.25, 3); // Ensure pdfscale does not exceed 3
                pageScaleDisplay.textContent = (pdfscale * 100).toFixed(0) + "%";
                renderPage(currentPage);
            });

            // Event listeners for zooming in and out
            document.getElementById("page-zoom-out").addEventListener("click", () => {
                if (pdfscale > 0.5) {
                    pdfscale = Math.max(pdfscale - 0.25, 0.5); // Ensure pdfscale does not go below 0.5
                    pageScaleDisplay.textContent = (pdfscale * 100).toFixed(0) + "%";
                    renderPage(currentPage);
                }
            });

            canvas.addEventListener("click", event => {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                lastClick = { x, y }; // Salva le coordinate dell'ultimo click

                input.style.left = `${x}px`;
                input.style.top = `${y}px`;
                input.style.display = "block";
                input.focus();

                const onKeyDown = (e) => {
                    if (e.key === "Enter" && input.value !== "") {
                        saveAnnotation(input.value, lastClick.x, lastClick.y, currentPage);
                        input.value = "";
                        input.style.display = "none";
                        input.removeEventListener("keydown", onKeyDown);
                        loadAnnotations();
                    } else if (e.key === "Escape") {
                        input.value = "";
                        input.style.display = "none";
                        input.removeEventListener("keydown", onKeyDown);
                    }
                };

                input.removeEventListener("keydown", onKeyDown); // prevent duplicates
                input.addEventListener("keydown", onKeyDown);
            });

            function saveAnnotation(text, x, y, page) {
                // TODO: add name of the author
                let data = JSON.parse(localStorage.getItem("annotations") || "[]");
                const id = `comment-${Date.now()}`;
                x = x / pdfscale;
                y = y / pdfscale;
                data.push({ id, text, x, y, page});
                localStorage.setItem("annotations", JSON.stringify(data));
            }

            function loadAnnotations() {
                markers.innerHTML = "";
                commentsList.innerHTML = "";
                counter = 1;
                totalAnnotations = 0;
                let data = JSON.parse(localStorage.getItem("annotations") || "[]");
                data.filter(a => a.page === currentPage).forEach(({ id, text, x, y}) => {
                    // Quadrato giallo
                    const marker = document.createElement("div");
                    marker.className = "marker";
                    marker.style.left = `${x*pdfscale}px`;
                    marker.style.top = `${y*pdfscale}px`;
                    marker.dataset.commentId = id;
                    marker.addEventListener("click", () => focusComment(id));
                    marker.innerText = counter;
                    markers.appendChild(marker);

                    // Commento nella sidebar
                    const comment = document.createElement("div");
                    comment.className = "comment";
                    comment.id = id;
                    comment.innerText = "(#"+counter+") " + text;
                    
                    const commentControl = document.createElement("div");
                    commentControl.className = "comment-control";
                    
                    const goToBtn = document.createElement("span");
                    goToBtn.title = "Find in document";
                    goToBtn.innerHTML = "<i class='fas fa-location-arrow'></i>";
                    commentControl.appendChild(goToBtn);

                    const deleteBtn = document.createElement("span");
                    deleteBtn.title = "Delete comment";
                    deleteBtn.innerHTML = "<i class='fas danger fa-trash-alt'></i>";
                    deleteBtn.addEventListener("click", () => {
                        if (confirm("Are you sure you want to delete this comment?")) {
                            let data = JSON.parse(localStorage.getItem("annotations") || "[]");
                            data = data.filter(a => a.id !== id);
                            localStorage.setItem("annotations", JSON.stringify(data));
                            loadAnnotations();
                        }
                    });
                    commentControl.appendChild(deleteBtn);

                    comment.appendChild(commentControl);
                    goToBtn.addEventListener("click", () => focusCommentFromSidebarToPDF(id));
                    commentsList.appendChild(comment);
                    
                    counter++;
                    totalAnnotations++;
                });
                totalPageComments.textContent = totalAnnotations;
                if (totalAnnotations === 0) {
                    commentsList.innerHTML = "<p class='muted'>No comments on this page.</p>";
                }
            }

            function focusCommentFromSidebarToPDF(id) {
                document.querySelectorAll(".comment").forEach(el => el.classList.remove("focused"));
                const target = document.getElementById(id);
                if (target) {
                    target.classList.add("focused");
                    setTimeout(() => target.classList.remove("focused"), 1500); // Remove highlight
                    const marker = document.querySelector(`.marker[data-comment-id='${id}']`);
                    if (marker) {
                        marker.scrollIntoView({ behavior: "smooth", block: "center" });
                        marker.classList.add("focused");
                        setTimeout(() => marker.classList.remove("focused"), 1500); // Remove highlight
                    }
                }
            }

            function focusComment(id) {
                document.querySelectorAll(".comment").forEach(el => el.classList.remove("focused"));
                const target = document.getElementById(id);
                if (target) {
                    target.classList.add("focused");
                    target.scrollIntoView({ behavior: "smooth", block: "center" });
                    setTimeout(() => target.classList.remove("focused"), 1500); // Remove highlight
                }
            }


            const resetScaleButton = document.getElementById("reset-scale");
            resetScaleButton.addEventListener("click", () => {
                pdfscale = pdfscaleDefault;
                pageScaleDisplay.textContent = (pdfscale * 100).toFixed(0) + "%";
                renderPage(currentPage);
                updateResetButtonVisibility();
            });

            function updateResetButtonVisibility() {
                resetScaleButton.style.display = (pdfscale !== pdfscaleDefault) ? "inline-block" : "none";
            }

            // Update visibility of reset button on zoom in/out
            document.getElementById("page-zoom-in").addEventListener("click", updateResetButtonVisibility);
            document.getElementById("page-zoom-out").addEventListener("click", updateResetButtonVisibility);
        </script>
    </div>

{% endblock %}